#  Client Code: Running existing tutorials  

In the cloned `service-layer-objmodel` git repo, there are a couple of tutorials that we intend to build and run. The first tutorial is the `quickstart` tutorial that utilizes the Route vertical of the Service Layer API to program IPv4 and IPv6 routes into the IOS-XR RIB.  The second tutorial called `rshuttle` is a much more exhaustive version of the Route Vertical tutorial that also allows us to test the performance of the Service-Layer API to determine the rate at which routes can be programmed into the IOS-XR RIB.


## Build the tutorials

Before we run the tutorials, we need to install client specific dependencies (additional libraries that the clients use) and then build the executables to be run.

### Run the `build_tutorials.sh` script

Drop into the `grpc/cpp/` directory under the git repo and dump the `build_tutorials.sh` script:


```bash
admin@devbox:cpp$ ls
build_libiosxrsl.sh  build_tutorials.sh  clean.sh  gen-bindings.sh  src
admin@devbox:cpp$
admin@devbox:cpp$ cat build_tutorials.sh
#!/bin/bash


usage="
$(basename "$0") [-h] [-g/--grpc-version -p/--protobuf-version -v/--verbose] -- script to install desired versions of grpc, protobuf and build the libiosxrsl.a library
where:
    -h  show this help text
    -g/--grpc-version  bring up the libvirt topology, wait for ssh access and then set up ssh tunnels
    -p/--protobuf-version  bring down the libvirt topology
    -v  get more verbose information during script execution
"

while true; do
  case "$1" in
    -v | --verbose )     VERBOSE=true; shift ;;
    -h | --help )        echo "$usage"; exit 0 ;;
    -g | --grpc-version )   GRPC_VERSION=$2; shift; shift;;
    -p | --protobuf-version ) PROTOBUF_VERSION=$2; shift; shift;;
    -- ) shift; break ;;
    * ) break ;;
  esac
done

if ! [[ $GRPC_VERSION ]] || ! [[ $PROTOBUF_VERSION ]]; then
   echo "Must specify both  -g/--grpc--version and -p/--protobuf-version, see usage below"
   echo "$usage"
   exit 0
fi

if [[ $VERBOSE ]];then
    set -x
fi



SCRIPT_DIR="$(cd "$(dirname "${0}")"; echo "$(pwd)")"

./build_libiosxrsl.sh -g $GRPC_VERSION -p $PROTOBUF_VERSION

mkdir -p ~/tempdir

# Install glog

if ! ldconfig -p | grep -q glog; then
    git clone https://github.com/google/glog.git ~/tempdir/glog
    cd ~/tempdir/glog
    ./autogen.sh && ./configure && make && make install && ldconfig
fi
# Clean up
cd ~/ && rm -rf ~/tempdir

# Clean up first
$SCRIPT_DIR/clean.sh

# Drop into the tutorial directory to build quickstart that links to libiosxrsl.a
cd $SCRIPT_DIR/src/tutorial
make

cd $SCRIPT_DIR/src/tutorial/rshuttle
make

admin@devbox:cpp$

```

This script has been constructed to first invoke `build_libiosxrsl.sh` which would install `grpc` and `protobuf` as per the user specified versions. It then progresses to install `glog`: a tool to enable different levels of verbosity for the logs generated by the client code.  

Once glog is installed, the build script then issues a `make` in the `grpc/cpp/src/tutorial` directory to build the `quickstart` tutorial before dropping into the `grpc/cpp/src/tutorial/rshuttle` directory to build the `rshuttle` tutorial.  


The Makefile for the quickstart tutorial can be found under `grpc/cpp/src/tutorial` and serves as a good template for writing your own.
As shown below, the Makefile looks for the header files under `/usr/local/include` (where we installed the service_layer header files in the previous section of this lab) and the Linker (using the LDFLAGS) looks for `grpc++`, `protobuf` and `iosxrsl` libraries (that we installed under `/usr/local/lib`).


```
admin@devbox:tutorial$ pwd
/home/admin/service-layer-objmodel/grpc/cpp/src/tutorial
admin@devbox:tutorial$
admin@devbox:tutorial$ ls -l Makefile
-rw-rw-r-- 1 admin admin 414 Sep  9 03:41 Makefile
admin@devbox:tutorial$
admin@devbox:tutorial$ cat Makefile
TARGET := quickstart
SRC_FILES := quickstart.cc
OBJ_FILES := quickstart.o
LDFLAGS := -L/usr/local/lib  -I/usr/local/include -lgrpc++_unsecure -lgrpc -lprotobuf -lpthread -ldl -liosxrsl
CPPFLAGS := -g -std=c++11 -I/usr/local/include -pthread

.PHONY: all
all: $(TARGET)

%.o: %.cc
	g++ $(CPPFLAGS) -c -o $@ $<

$(TARGET): $(OBJ_FILES)
	g++ $^ $(LDFLAGS) -o $@


.PHONY: clean
clean:
	-${RM} ${TARGET} ${OBJ_FILES}
admin@devbox:tutorial$



```

Running the build script, we get:


```
admin@devbox:cpp$ sudo ./build_tutorials.sh -g 1.7.0 -p 3.5.0
[sudo] password for admin:
Hit:1 http://ppa.launchpad.net/ansible/ansible/ubuntu xenial InRelease
Hit:2 http://us.archive.ubuntu.com/ubuntu xenial InRelease                                                                           
Get:3 http://security.ubuntu.com/ubuntu xenial-security InRelease [107 kB]
Get:4 http://us.archive.ubuntu.com/ubuntu xenial-updates InRelease [109 kB]        
Hit:5 https://download.docker.com/linux/ubuntu xenial InRelease                               
Get:6 http://us.archive.ubuntu.com/ubuntu xenial-backports InRelease [107 kB]
Fetched 323 kB in 1s (192 kB/s)
Reading package lists... Done
Reading package lists... Done
Building dependency tree       
Reading state information... Done
autoconf is already the newest version (2.69-9).
automake is already the newest version (1:1.15-4ubuntu1).
g++ is already the newest version (4:5.3.1-1ubuntu1).
libtool is already the newest version (2.4.6-0.1).
make is already the newest version (4.1-6).
pkg-config is already the newest version (0.29.1-0ubuntu1).
unzip is already the newest version (6.0-20ubuntu1).
curl is already the newest version (7.47.0-1ubuntu2.8).
git is already the newest version (1:2.7.4-0ubuntu1.4).
The following packages were automatically installed and are no longer required:
  linux-headers-4.4.0-119 linux-headers-4.4.0-119-generic linux-image-4.4.0-119-generic linux-image-extra-4.4.0-119-generic
Use 'sudo apt autoremove' to remove them.
0 upgraded, 0 newly installed, 0 to remove and 30 not upgraded.
+++ dirname /home/admin/service-layer-objmodel/grpc/cpp/clean.sh
++ cd /home/admin/service-layer-objmodel/grpc/cpp
+++ pwd
++ echo /home/admin/service-layer-objmodel/grpc/cpp
+ SCRIPT_DIR=/home/admin/service-layer-objmodel/grpc/cpp
+ cd /home/admin/service-layer-objmodel/grpc/cpp/src
+ make clean
rm -f   libiosxrsl.a  genobj/sl_route_common.pb.o genobj/sl_route_ipv6.grpc.pb.o genobj/sl_global.pb.o genobj/sl_common_types.grpc.pb.o genobj/sl_route_ipv6.pb.o genobj/sl_global.grpc.pb.o genobj/sl_common_types.pb.o genobj/sl_route_ipv4.grpc.pb.o genobj/sl_bfd_ipv4.pb.o genobj/sl_version.pb.o genobj/sl_route_ipv4.pb.o genobj/sl_bfd_ipv4.grpc.pb.o genobj/sl_route_common.grpc.pb.o genobj/sl_bfd_common.grpc.pb.o genobj/sl_mpls.grpc.pb.o genobj/sl_bfd_common.pb.o genobj/sl_bfd_ipv6.grpc.pb.o genobj/sl_mpls.pb.o genobj/sl_bfd_ipv6.pb.o genobj/sl_interface.grpc.pb.o genobj/sl_version.grpc.pb.o genobj/sl_interface.pb.o gencpp/sl_route_common.pb.cc gencpp/sl_route_ipv6.grpc.pb.cc gencpp/sl_global.pb.cc gencpp/sl_common_types.grpc.pb.cc gencpp/sl_route_ipv6.pb.cc gencpp/sl_global.grpc.pb.cc gencpp/sl_common_types.pb.cc gencpp/sl_route_ipv4.grpc.pb.cc gencpp/sl_bfd_ipv4.pb.cc gencpp/sl_version.pb.cc gencpp/sl_route_ipv4.pb.cc gencpp/sl_bfd_ipv4.grpc.pb.cc gencpp/sl_route_common.grpc.pb.cc gencpp/sl_bfd_common.grpc.pb.cc gencpp/sl_mpls.grpc.pb.cc gencpp/sl_bfd_common.pb.cc gencpp/sl_bfd_ipv6.grpc.pb.cc gencpp/sl_mpls.pb.cc gencpp/sl_bfd_ipv6.pb.cc gencpp/sl_interface.grpc.pb.cc gencpp/sl_version.grpc.pb.cc gencpp/sl_interface.pb.cc gencpp/sl_interface.pb.h gencpp/sl_bfd_ipv4.pb.h gencpp/sl_version.pb.h gencpp/sl_route_ipv6.grpc.pb.h gencpp/sl_route_common.grpc.pb.h gencpp/sl_common_types.grpc.pb.h gencpp/sl_route_ipv6.pb.h gencpp/sl_global.grpc.pb.h gencpp/sl_common_types.pb.h gencpp/sl_route_ipv4.grpc.pb.h gencpp/sl_global.pb.h gencpp/sl_route_ipv4.pb.h gencpp/sl_bfd_common.grpc.pb.h gencpp/sl_mpls.grpc.pb.h gencpp/sl_bfd_common.pb.h gencpp/sl_bfd_ipv6.grpc.pb.h gencpp/sl_mpls.pb.h gencpp/sl_bfd_ipv6.pb.h gencpp/sl_route_common.pb.h gencpp/sl_interface.grpc.pb.h gencpp/sl_bfd_ipv4.grpc.pb.h gencpp/sl_version.grpc.pb.h
+ cd /home/admin/service-layer-objmodel/grpc/cpp/src/tutorial
+ make clean
rm -f quickstart quickstart.o
+ cd /home/admin/service-layer-objmodel/grpc/cpp/src/tutorial/rshuttle
+ make clean
rm -f servicelayermain  ServiceLayerMain.o ServiceLayerRoute.o ServiceLayerAsyncInit.o
Generating cplusplus bindings...Done
+++ dirname /home/admin/service-layer-objmodel/grpc/cpp/clean.sh
++ cd /home/admin/service-layer-objmodel/grpc/cpp
+++ pwd
++ echo /home/admin/service-layer-objmodel/grpc/cpp
+ SCRIPT_DIR=/home/admin/service-layer-objmodel/grpc/cpp
+ cd /home/admin/service-layer-objmodel/grpc/cpp/src
+ make clean
rm -f   libiosxrsl.a  genobj/sl_route_common.pb.o genobj/sl_route_ipv6.grpc.pb.o genobj/sl_global.pb.o genobj/sl_common_types.grpc.pb.o genobj/sl_route_ipv6.pb.o genobj/sl_global.grpc.pb.o genobj/sl_common_types.pb.o genobj/sl_route_ipv4.grpc.pb.o genobj/sl_bfd_ipv4.pb.o genobj/sl_version.pb.o genobj/sl_route_ipv4.pb.o genobj/sl_bfd_ipv4.grpc.pb.o genobj/sl_route_common.grpc.pb.o genobj/sl_bfd_common.grpc.pb.o genobj/sl_mpls.grpc.pb.o genobj/sl_bfd_common.pb.o genobj/sl_bfd_ipv6.grpc.pb.o genobj/sl_mpls.pb.o genobj/sl_bfd_ipv6.pb.o genobj/sl_interface.grpc.pb.o genobj/sl_version.grpc.pb.o genobj/sl_interface.pb.o gencpp/sl_route_common.pb.cc gencpp/sl_route_ipv6.grpc.pb.cc gencpp/sl_global.pb.cc gencpp/sl_common_types.grpc.pb.cc gencpp/sl_route_ipv6.pb.cc gencpp/sl_global.grpc.pb.cc gencpp/sl_common_types.pb.cc gencpp/sl_route_ipv4.grpc.pb.cc gencpp/sl_bfd_ipv4.pb.cc gencpp/sl_version.pb.cc gencpp/sl_route_ipv4.pb.cc gencpp/sl_bfd_ipv4.grpc.pb.cc gencpp/sl_route_common.grpc.pb.cc gencpp/sl_bfd_common.grpc.pb.cc gencpp/sl_mpls.grpc.pb.cc gencpp/sl_bfd_common.pb.cc gencpp/sl_bfd_ipv6.grpc.pb.cc gencpp/sl_mpls.pb.cc gencpp/sl_bfd_ipv6.pb.cc gencpp/sl_interface.grpc.pb.cc gencpp/sl_version.grpc.pb.cc gencpp/sl_interface.pb.cc gencpp/sl_interface.pb.h gencpp/sl_bfd_ipv4.pb.h gencpp/sl_version.pb.h gencpp/sl_route_ipv6.grpc.pb.h gencpp/sl_route_common.grpc.pb.h gencpp/sl_common_types.grpc.pb.h gencpp/sl_route_ipv6.pb.h gencpp/sl_global.grpc.pb.h gencpp/sl_common_types.pb.h gencpp/sl_route_ipv4.grpc.pb.h gencpp/sl_global.pb.h gencpp/sl_route_ipv4.pb.h gencpp/sl_bfd_common.grpc.pb.h gencpp/sl_mpls.grpc.pb.h gencpp/sl_bfd_common.pb.h gencpp/sl_bfd_ipv6.grpc.pb.h gencpp/sl_mpls.pb.h gencpp/sl_bfd_ipv6.pb.h gencpp/sl_route_common.pb.h gencpp/sl_interface.grpc.pb.h gencpp/sl_bfd_ipv4.grpc.pb.h gencpp/sl_version.grpc.pb.h
+ cd /home/admin/service-layer-objmodel/grpc/cpp/src/tutorial
+ make clean
rm -f quickstart quickstart.o
+ cd /home/admin/service-layer-objmodel/grpc/cpp/src/tutorial/rshuttle
+ make clean
rm -f servicelayermain  ServiceLayerMain.o ServiceLayerRoute.o ServiceLayerAsyncInit.o
g++ -g -std=c++11 -I/usr/local/include -pthread -c -o quickstart.o quickstart.cc
g++ quickstart.o -L/usr/local/lib  -I/usr/local/include -lgrpc++_unsecure -lgrpc -lprotobuf -lpthread -ldl -liosxrsl -o quickstart
g++  -g -std=c++11 -I/usr/local/include -pthread  -c -o ServiceLayerMain.o ServiceLayerMain.cpp
g++  -g -std=c++11 -I/usr/local/include -pthread  -c -o ServiceLayerRoute.o ServiceLayerRoute.cpp
g++  -g -std=c++11 -I/usr/local/include -pthread  -c -o ServiceLayerAsyncInit.o ServiceLayerAsyncInit.cpp
g++ ServiceLayerMain.o ServiceLayerRoute.o ServiceLayerAsyncInit.o -L/usr/local/lib -I/usr/local/include -lgrpc++_unsecure -lgrpc -lprotobuf -lpthread -ldl -liosxrsl -lglog  -o servicelayermain
admin@devbox:cpp$
admin@devbox:cpp$
admin@devbox:cpp$
admin@devbox:cpp$
```


<p style="margin: 2em 0!important;padding: 1em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 1em !important;text-indent: initial;background-color: #eff9ef;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);">Perfect! The tutorials were built successfully. Time to execute!
</p>  


## Run the Tutorials

### Running the Quickstart Tutorial

Drop into the `grpc/cpp/src/tutorial` directory:

```
admin@devbox:tutorial$ pwd
/home/admin/service-layer-objmodel/grpc/cpp/src/tutorial
admin@devbox:tutorial$
admin@devbox:tutorial$ ls -l
total 7928
-rw-rw-r-- 1 admin admin     414 Sep  9 03:41 Makefile
-rwxr-xr-x 1 root  root  6017912 Sep  9 05:37 quickstart
-rw-rw-r-- 1 admin admin   26648 Sep  9 03:41 quickstart.cc
-rw-rw-r-- 1 admin admin    4470 Sep  9 03:41 quickstart.h
-rw-r--r-- 1 root  root  2052056 Sep  9 05:37 quickstart.o
drwxrwxr-x 2 admin admin    4096 Sep  9 05:37 rshuttle
admin@devbox:tutorial$

```
`quickstart` is the executable we're looking for. Running it, we get:

```
admin@devbox:tutorial$
admin@devbox:tutorial$ ./quickstart
SERVER_IP environment variable not set
SERVER_PORT environment variable not set
admin@devbox:tutorial$

```

We need to specify the accessible gRPC port (SERVER_PORT) open on the router and the reachable IP address (SERVER_IP) as environment variables.

```
admin@devbox:tutorial$ export SERVER_IP=10.10.20.170
admin@devbox:tutorial$ export SERVER_PORT=57021

```

Now, run the tutorial with the environment variable `GLOG_v=3` set in the shell so as enable a higher verbosity (level 3) of logging that would showcase the different messages being sent by the client:


```
admin@devbox:tutorial$ GLOG_v=3 ./quickstart


Connecting to grpc server at 10.10.20.170:57021


###########################
Transmitted message: IOSXR-SL INIT SubVer: 1
###########################


Server returned
Successfully Initialized, connection Established!


###########################
Transmitted message: IOSXR-SL VRF Oper: SL_REGOP_REGISTER
VrfRegMsgs {
  VrfName: "default"
  AdminDistance: 10
  VrfPurgeIntervalSeconds: 500
}
###########################


RPC call was successful, checking response...
IPv4 Vrf Operation:1 Successful


###########################
Transmitted message: IOSXR-SL VRF Oper: SL_REGOP_EOF
VrfRegMsgs {
  VrfName: "default"
  AdminDistance: 10
  VrfPurgeIntervalSeconds: 500
}
###########################


RPC call was successful, checking response...
IPv4 Vrf Operation:3 Successful


###########################
Transmitted message: IOSXR-SL VRF Oper: SL_REGOP_REGISTER
VrfRegMsgs {
  VrfName: "default"
  AdminDistance: 10
  VrfPurgeIntervalSeconds: 500
}
###########################


RPC call was successful, checking response...
IPv6 Vrf Operation: 1 successful


###########################
Transmitted message: IOSXR-SL VRF Oper: SL_REGOP_EOF
VrfRegMsgs {
  VrfName: "default"
  AdminDistance: 10
  VrfPurgeIntervalSeconds: 500
}
###########################


RPC call was successful, checking response...
IPv6 Vrf Operation: 3 successful


###########################
Transmitted message: IOSXR-SL RouteV4 Oper: SL_OBJOP_UPDATE
VrfName: "default"
Routes {
  Prefix: 335544576
  PrefixLen: 24
  RouteCommon {
    AdminDistance: 120
  }
  PathList {
    NexthopAddress {
      V4Address: 234946826
    }
    NexthopInterface {
      Name: "GigabitEthernet0/0/0/0"
    }
  }
}
Routes {
  Prefix: 385876224
  PrefixLen: 24
  RouteCommon {
    AdminDistance: 120
  }
  PathList {
    NexthopAddress {
      V4Address: 234946826
    }
    NexthopInterface {
      Name: "GigabitEthernet0/0/0/0"
    }
  }
}
###########################


RPC call was successful, checking response...
IPv4 Route Operation:2 Successful


###########################
Transmitted message: IOSXR-SL RouteV6 Oper: SL_OBJOP_UPDATE
VrfName: "default"
Routes {
  Prefix: " \002\000\252\000\000\000\000\000\000\000\000\000\000\000\000"
  PrefixLen: 64
  RouteCommon {
    AdminDistance: 120
  }
  PathList {
    NexthopAddress {
      V6Address: " \002\000\256\000\000\000\000\000\000\000\000\000\000\000\003"
    }
    NexthopInterface {
      Name: "GigabitEthernet0/0/0/0"
    }
  }
}
###########################


RPC call was successful, checking response...
IPv6 Route Operation:2 Successful
Press control-c to quit

Received Heartbeat
Received Heartbeat

```

From the messages it can be seen that the quickstart client sends out the following messages:

1. **An initialization message** with the required Version fields set: This channel must also be kept running in a separate thread as the client proceeds to register for specific functionality verticals and execute associated RPCs.

  <p><pre><code>
  ###########################
  Transmitted message: IOSXR-SL INIT SubVer: 1
  ###########################

  Server returned
  Successfully Initialized, connection Established!
  </code></pre></p>

2. **IPv4 VRF Registration Message**: An Initial REGISTER followed by an EOF message (to purge stale IPv4 routes in the RIB) for the vrf `default` is then sent to register for the IPv4 Route vertical.

  ```
  ###########################
  Transmitted message: IOSXR-SL VRF Oper: SL_REGOP_REGISTER
  VrfRegMsgs {
    VrfName: "default"
    AdminDistance: 10
    VrfPurgeIntervalSeconds: 500
  }
  ###########################

  RPC call was successful, checking response...
  IPv4 Vrf Operation:1 Successful

  ###########################
  Transmitted message: IOSXR-SL VRF Oper: SL_REGOP_EOF
  VrfRegMsgs {
    VrfName: "default"
    AdminDistance: 10
    VrfPurgeIntervalSeconds: 500
  }
  ###########################

  RPC call was successful, checking response...
  IPv4 Vrf Operation:3 Successful

  ```  

3. **IPv6 Registration Message**: An Initial REGISTER followed by an EOF message (to purge stale IPv6 routes in the RIB) for the vrf `default` is then sent to register for the IPv6 Route vertical.

  ```
  ###########################
  Transmitted message: IOSXR-SL VRF Oper: SL_REGOP_REGISTER
  VrfRegMsgs {
    VrfName: "default"
    AdminDistance: 10
    VrfPurgeIntervalSeconds: 500
  }
  ###########################

  RPC call was successful, checking response...
  IPv6 Vrf Operation: 1 successful

  ###########################
  Transmitted message: IOSXR-SL VRF Oper: SL_REGOP_EOF
  VrfRegMsgs {
    VrfName: "default"
    AdminDistance: 10
    VrfPurgeIntervalSeconds: 500
  }
  ###########################

  RPC call was successful, checking response...
  IPv6 Vrf Operation: 3 successful

  ```

4. **IPv4 Route Operation**: Post registration, ROUTE_UPDATE messages for the IPv4 Route Vertial are then sent to add/update IPv4 routes into the IOS-XR RIB:

  ```
  ###########################
  Transmitted message: IOSXR-SL RouteV4 Oper: SL_OBJOP_UPDATE
  VrfName: "default"
  Routes {
    Prefix: 335544576
    PrefixLen: 24
    RouteCommon {
      AdminDistance: 120
    }
    PathList {
      NexthopAddress {
        V4Address: 234946826
      }
      NexthopInterface {
        Name: "GigabitEthernet0/0/0/0"
      }
    }
  }
  Routes {
    Prefix: 385876224
    PrefixLen: 24
    RouteCommon {
      AdminDistance: 120
    }
    PathList {
      NexthopAddress {
        V4Address: 234946826
      }
      NexthopInterface {
        Name: "GigabitEthernet0/0/0/0"
      }
    }
  }
  ###########################

  RPC call was successful, checking response...
  IPv4 Route Operation:2 Successful

  ```

5. **IPv6 Route Operation**: Similarly, ROUTE_UPDATE messages are sent to the IPv6 Route Vertical to add/update IPv6 routes into the IOS-XR RIB:

  ```
  ###########################
  Transmitted message: IOSXR-SL RouteV6 Oper: SL_OBJOP_UPDATE
  VrfName: "default"
  Routes {
    Prefix: " \002\000\252\000\000\000\000\000\000\000\000\000\000\000\000"
    PrefixLen: 64
    RouteCommon {
      AdminDistance: 120
    }
    PathList {
      NexthopAddress {
        V6Address: " \002\000\256\000\000\000\000\000\000\000\000\000\000\000\003"
      }
      NexthopInterface {
        Name: "GigabitEthernet0/0/0/0"
      }
    }
  }
  ###########################

  RPC call was successful, checking response...
  IPv6 Route Operation:2 Successful
  Press control-c to quit

  ```


### Effect of Quickstart Client on the Router

Log into router `r1` and dump the current route table for IPv4 and IPv6 routes:

<p style="margin: 2em 0!important;padding: 1em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 1em !important;text-indent: initial;background-color: #e6f2f7;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);">**Username**: admin<br/>**Password**: admin<br/>**SSH port**: 2221
</p>  


```
RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#show  route ipv4
Sun Sep  9 13:28:44.267 UTC

Codes: C - connected, S - static, R - RIP, B - BGP, (>) - Diversion path
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2, E - EGP
       i - ISIS, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, su - IS-IS summary null, * - candidate default
       U - per-user static route, o - ODR, L - local, G  - DAGR, l - LISP
       A - access/subscriber, a - Application route
       M - mobile route, r - RPL, t - Traffic Engineering, (!) - FRR Backup path

Gateway of last resort is 192.168.122.1 to network 0.0.0.0

S*   0.0.0.0/0 [1/0] via 192.168.122.1, 12:46:43
a    20.0.1.0/24 [120/0] via 14.1.1.10, 00:40:01, GigabitEthernet0/0/0/0
a    23.0.1.0/24 [120/0] via 14.1.1.10, 00:40:01, GigabitEthernet0/0/0/0
C    192.168.122.0/24 is directly connected, 13:00:48, MgmtEth0/RP0/CPU0/0
L    192.168.122.21/32 is directly connected, 13:00:48, MgmtEth0/RP0/CPU0/0
RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#show  route ipv6
Sun Sep  9 13:28:49.094 UTC

Codes: C - connected, S - static, R - RIP, B - BGP, (>) - Diversion path
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2, E - EGP
       i - ISIS, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, su - IS-IS summary null, * - candidate default
       U - per-user static route, o - ODR, L - local, G  - DAGR, l - LISP
       A - access/subscriber, a - Application route
       M - mobile route, r - RPL, t - Traffic Engineering, (!) - FRR Backup path

Gateway of last resort is not set

a    2002:aa::/64
      [120/0] via 2002:ae::3, 00:40:06, GigabitEthernet0/0/0/0
RP/0/RP0/CPU0:r1#

```

Notice the `a` routes in both the IPv4 and the IPv6 RIB ? These are the routes added by the quickstart client.

### Bring down the Quickstart client

Issue a `^C` (ctrl+C) in the shell running the quickstart tutorial. We should then see the following messages roll down upon shutdown of the client:

```
Received Heartbeat
^CInterrupt signal (2) received.
IPv4 VRF Operation


###########################
Transmitted message: IOSXR-SL VRF Oper: SL_REGOP_UNREGISTER
VrfRegMsgs {
  VrfName: "default"
}
###########################


RPC call was successful, checking response...
IPv4 Vrf Operation:2 Successful
IPv6 VRF Operation


###########################
Transmitted message: IOSXR-SL VRF Oper: SL_REGOP_UNREGISTER
VrfRegMsgs {
  VrfName: "default"
}
###########################


RPC call was successful, checking response...
IPv6 Vrf Operation: 2 successful
Asynchronous client shutdown requested
Let's clean up!
Server Response Completed: 0x7fff7fa77040 CallData: 0x7fff7fa77040
Shutting down the completion queue
Notifying channel close
admin@devbox:tutorial$

```

It can be seen that the client traps the interrupt signal and immediately sends out an UNREGISTER for both IPv4 and IPv6 Route Verticals. This will force the router to purge the routes. This logic of clearing the routes from the IOS-XR RIB upon disconnect is not mandatory and the user can choose to keep the routes in V4 and V6 RIB upto a `max_time = VrfPurgeIntervalSeconds` that was set as part of the Registration message (500 seconds for this client).  


Checking the router's RIB state again:

```
RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#show  route ipv4
Sun Sep  9 13:36:53.152 UTC

Codes: C - connected, S - static, R - RIP, B - BGP, (>) - Diversion path
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2, E - EGP
       i - ISIS, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, su - IS-IS summary null, * - candidate default
       U - per-user static route, o - ODR, L - local, G  - DAGR, l - LISP
       A - access/subscriber, a - Application route
       M - mobile route, r - RPL, t - Traffic Engineering, (!) - FRR Backup path

Gateway of last resort is 192.168.122.1 to network 0.0.0.0

S*   0.0.0.0/0 [1/0] via 192.168.122.1, 12:54:52
C    192.168.122.0/24 is directly connected, 13:08:56, MgmtEth0/RP0/CPU0/0
L    192.168.122.21/32 is directly connected, 13:08:56, MgmtEth0/RP0/CPU0/0
RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#show  route ipv6
Sun Sep  9 13:36:55.104 UTC

% No matching routes found

RP/0/RP0/CPU0:r1#

```

Perfect! All the routes have been flushed out.


### Running the `rshuttle` tutorial

The purpose of the rshuttle tutorial is to determine the rate at which a client is able to program routes into the IOS-XR RIB over the highly performant channel to the RIB through the service-layer API.

Now, the performance of the program would be affected by the location of the client : the number of hops and indirections that the client connection must go through to send a route batch to the router's RIB.  

We just ran the `quickstart` tutorial by connecting to the router's gRPC port over the IP address=`10.10.20.170`. This is actually the external address of the NAT-TED connection to the router forcing the client to go through an unnecessary detour and would reduce performance.

So, let's use the private IP of the router `r1` reachable from the devbox instead.

Drop into the router and determine the Mgmt port's IP address:

```
RP/0/RP0/CPU0:r1#show  ipv4 interface brief
Sun Sep  9 13:45:29.668 UTC

Interface                      IP-Address      Status          Protocol Vrf-Name
MgmtEth0/RP0/CPU0/0            192.168.122.21  Up              Up       default
GigabitEthernet0/0/0/0         unassigned      Shutdown        Down     default
GigabitEthernet0/0/0/1         unassigned      Shutdown        Down     default
GigabitEthernet0/0/0/2         unassigned      Shutdown        Down     default
GigabitEthernet0/0/0/3         unassigned      Shutdown        Down     default
GigabitEthernet0/0/0/4         unassigned      Shutdown        Down     default
RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#show running-config grpc
Sun Sep  9 13:46:16.519 UTC
grpc
 port 57777
 no-tls
 service-layer
 !
!

RP/0/RP0/CPU0:r1#

```

Since this IP address is reachable from the `devbox` directly, the gRPC port to be used = `57777`.

With these connection details, let's run the `rshuttle` tutorial:

Drop into the `grpc/cpp/src/tutorial/rshuttle` directory and execute the `servicelayermain` binary:

```
admin@devbox:rshuttle$ pwd
/home/admin/service-layer-objmodel/grpc/cpp/src/tutorial/rshuttle
admin@devbox:rshuttle$
admin@devbox:rshuttle$ ls -l
total 10868
-rw-rw-r-- 1 admin admin     453 Sep  9 03:41 Makefile
-rw-rw-r-- 1 admin admin    6797 Sep  9 03:41 ServiceLayerAsyncInit.cpp
-rw-rw-r-- 1 admin admin    2001 Sep  9 03:41 ServiceLayerAsyncInit.h
-rw-r--r-- 1 root  root  1124688 Sep  9 05:37 ServiceLayerAsyncInit.o
-rwxr-xr-x 1 root  root  6645552 Sep  9 05:37 servicelayermain
-rw-rw-r-- 1 admin admin    5258 Sep  9 03:41 ServiceLayerMain.cpp
-rw-r--r-- 1 root  root  1441416 Sep  9 05:37 ServiceLayerMain.o
-rw-rw-r-- 1 admin admin   52160 Sep  9 03:41 ServiceLayerRoute.cpp
-rw-rw-r-- 1 admin admin    6777 Sep  9 03:41 ServiceLayerRoute.h
-rw-r--r-- 1 root  root  1823968 Sep  9 05:37 ServiceLayerRoute.o
admin@devbox:rshuttle$
```  

Set the Environment variables (SERVER_IP and SERVER_PORT):  

```
admin@devbox:rshuttle$ export SERVER_IP=192.168.122.21
admin@devbox:rshuttle$ export SERVER_PORT=57777
admin@devbox:rshuttle$
```

Execute the `servicelayermain` binary:


```
admin@devbox:rshuttle$
admin@devbox:rshuttle$ ./servicelayermain
WARNING: Logging before InitGoogleLogging() is written to STDERR
I0909 06:48:47.333315 32242 ServiceLayerMain.cpp:139] Connecting IOS-XR to gRPC server at 192.168.122.21:57777
I0909 06:48:47.357028 32242 ServiceLayerMain.cpp:89] Starting Route batch
I0909 06:48:51.287119 32242 ServiceLayerMain.cpp:110]
Time taken to program 100352 routes
 3.92987
Route programming rate
25535.7 routes/sec
I0909 06:48:51.290458 32242 ServiceLayerMain.cpp:185] Press control-c to quit

```

<p style="margin: 2em 0!important;padding: 1em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 1em !important;text-indent: initial;background-color: #eff9ef;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);">
Impressive! The client was able to program 100352 routes at a rate of 25535.7 routes/second.  
<br/>
This Route programming rate is significantly higher (magnitude x2) than most Network ASIC's route download capability in the market today. This implies that  for controllers and protocol stacks, the software stack will never be the bottleneck when it comes to performance and overall convergence rates for controller based routes will only improve as ASICs get better, all thanks to the service-layer API.   
<br/>
When we look to run the client as an on-box application on the router in a subsequent lab, we will notice that the programming rate is infact even higher (close to 40000 routes/second).
</p>
